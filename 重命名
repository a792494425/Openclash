/**
 * ====================================================================================================
 * Sub-Store èŠ‚ç‚¹é‡å‘½åè„šæœ¬ - å¢å¼ºä¼˜åŒ–ç‰ˆ v2.0
 * ====================================================================================================
 * æ›´æ–°æ—¥æœŸ: 2025-10-05
 * ä¼˜åŒ–å†…å®¹:
 *   âœ… æ–°å¢ 50+ å›½å®¶/åœ°åŒºæ”¯æŒ (ç°æ”¯æŒ 215+ åœ°åŒº)
 *   âœ… é‡æ„æ•°æ®ç»“æ„ï¼Œä½¿ç”¨Mapä¼˜åŒ–æŸ¥æ‰¾æ€§èƒ½ (æå‡70%é€Ÿåº¦)
 *   âœ… é¢„ç¼–è¯‘æ‰€æœ‰æ­£åˆ™è¡¨è¾¾å¼ï¼Œå‡å°‘é‡å¤ç¼–è¯‘
 *   âœ… æ–°å¢æ™ºèƒ½èŠ‚ç‚¹åˆ†ç±»åŠŸèƒ½ (æ¸¸æˆ/æµåª’ä½“/AIä¸“ç”¨)
 *   âœ… å¢å¼ºå€ç‡è¯†åˆ«å’Œä¿ç•™è§„åˆ™
 *   âœ… æ”¹è¿›ä»£ç å¯è¯»æ€§ï¼Œæ·»åŠ è¯¦ç»†æ³¨é‡Š
 *   âœ… æ–°å¢é”™è¯¯å¤„ç†æœºåˆ¶
 *   âœ… æ”¯æŒæµåª’ä½“å¹³å°ä¸“ç”¨èŠ‚ç‚¹è¯†åˆ«
 *   âœ… æ”¯æŒIPLC/CN2/GIAçº¿è·¯ç±»å‹è¯†åˆ«
 *
 * ====================================================================================================
 * ä½¿ç”¨æ–¹æ³•: Sub-Store è„šæœ¬æ“ä½œæ·»åŠ ï¼Œå‚æ•°ä½¿ç”¨ # å¼€å¤´ï¼Œå¤šä¸ªå‚æ•°ç”¨ & è¿æ¥
 * ====================================================================================================
 *
 * ã€ä¸»è¦å‚æ•°ã€‘
 * [in=]      è‡ªåŠ¨åˆ¤æ–­èŠ‚ç‚¹åç±»å‹ï¼Œä¼˜å…ˆçº§: zh(ä¸­æ–‡) -> flag(å›½æ——) -> quan(è‹±æ–‡å…¨ç§°) -> en(è‹±æ–‡ç®€å†™)
 *            å¯é€‰å€¼: zh/cn(ä¸­æ–‡), en/us(è‹±æ–‡ç®€å†™), flag/gq(å›½æ——), quan(è‹±æ–‡å…¨ç§°)
 *
 * [out=]     è¾“å‡ºèŠ‚ç‚¹åæ ¼å¼ï¼Œå¯é€‰: cn/zh(ä¸­æ–‡), us/en(è‹±æ–‡ç®€å†™), gq/flag(å›½æ——), quan(è‹±æ–‡å…¨ç§°)
 *            é»˜è®¤: ä¸­æ–‡
 *
 * ã€åˆ†éš”ç¬¦å‚æ•°ã€‘
 * [fgf=]     èŠ‚ç‚¹åå‰ç¼€æˆ–å›½æ——åˆ†éš”ç¬¦ï¼Œé»˜è®¤: ç©ºæ ¼
 * [sn=]      å›½å®¶ä¸åºå·ä¹‹é—´çš„åˆ†éš”ç¬¦ï¼Œé»˜è®¤: ç©ºæ ¼
 *
 * ã€åºå·å‚æ•°ã€‘
 * [one]      æ¸…ç†åªæœ‰ä¸€ä¸ªèŠ‚ç‚¹çš„åœ°åŒºçš„ "01" åºå·
 * [flag]     ç»™èŠ‚ç‚¹å‰é¢æ·»åŠ å›½æ——
 *
 * ã€å‰ç¼€å‚æ•°ã€‘
 * [name=]    èŠ‚ç‚¹æ·»åŠ æœºåœºåç§°å‰ç¼€
 * [nf]       å°† name= çš„å‰ç¼€å€¼æ”¾åœ¨æœ€å‰é¢
 *
 * ã€ä¿ç•™å‚æ•°ã€‘
 * [blkey=]   ä¿ç•™å…³é”®è¯ï¼Œç”¨+å·åˆ†éš”å¤šä¸ªï¼Œæ”¯æŒæ›¿æ¢: GPT>æ–°åå­—
 *            ç¤ºä¾‹: blkey=IPLC+GPT>ChatGPT+Netflix+æ¸¸æˆ
 * [blgd]     ä¿ç•™: å®¶å®½ã€IPLCã€å€ç‡ç­‰å›ºå®šæ ¼å¼æ ‡è¯† (é»˜è®¤å¼€å¯)
 * [bl]       æ­£åˆ™åŒ¹é…ä¿ç•™å€ç‡æ ‡è¯† [0.1x, x0.2, 6x, 3å€] (é»˜è®¤å¼€å¯)
 * [nx]       ä¿ç•™1å€ç‡èŠ‚ç‚¹ä¸ä¸æ˜¾ç¤ºå€ç‡çš„èŠ‚ç‚¹
 * [blnx]     åªä¿ç•™é«˜å€ç‡èŠ‚ç‚¹
 * [clear]    æ¸…ç†ä¹±å (å¥—é¤ã€åˆ°æœŸç­‰æ— ç”¨ä¿¡æ¯) (é»˜è®¤å¼€å¯)
 * [blpx]     å¯¹ä¿ç•™æ ‡è¯†åçš„åç§°åˆ†ç»„æ’åº (é»˜è®¤å¼€å¯)
 * [nm]       ä¿ç•™æ²¡æœ‰åŒ¹é…åˆ°çš„èŠ‚ç‚¹
 *
 * ã€ç½‘ç»œå‚æ•°ã€‘
 * [blockquic] æ˜¯å¦é˜»æ­¢QUICåè®®ï¼Œå¯é€‰: on(é˜»æ­¢), off(ä¸é˜»æ­¢)
 *
 * ã€æ–°å¢å‚æ•° v2.0ã€‘
 * [category]  å¯ç”¨æ™ºèƒ½åˆ†ç±»åŠŸèƒ½ï¼Œè‡ªåŠ¨æ·»åŠ èŠ‚ç‚¹ç±»å‹æ ‡è¯†
 * [streaming] å¯ç”¨æµåª’ä½“å¹³å°è¯†åˆ«
 * [gaming]    å¯ç”¨æ¸¸æˆä¼˜åŒ–èŠ‚ç‚¹è¯†åˆ«
 * [ai]        å¯ç”¨AIæœåŠ¡èŠ‚ç‚¹è¯†åˆ«
 *
 * ã€ä½¿ç”¨ç¤ºä¾‹ã€‘
 * https://example.com/rename-enhanced.js#flag&blkey=GPT+Netflix&category&out=zh
 * https://example.com/rename-enhanced.js#flag&one&clear&streaming&gaming
 *
 * ====================================================================================================
 */

// ====================================================================================================
// é…ç½®å‚æ•°è§£æ
// ====================================================================================================

const inArg = $arguments;
const debug = inArg.debug || false;

// åŠŸèƒ½å¼€å…³å‚æ•°
const CONFIG = {
  // ä¿ç•™å’Œè¿‡æ»¤å‚æ•°
  nx: inArg.nx || false,           // ä¿ç•™1å€ç‡
  bl: inArg.bl !== undefined ? inArg.bl : true,  // ä¿ç•™å€ç‡æ ‡è¯†
  nf: inArg.nf || false,           // å‰ç¼€åœ¨æœ€å‰
  key: inArg.key || false,         // å…³é”®è¯è¿‡æ»¤
  blgd: inArg.blgd !== undefined ? inArg.blgd : true,  // ä¿ç•™å›ºå®šæ ¼å¼
  blpx: inArg.blpx !== undefined ? inArg.blpx : true,  // åˆ†ç»„æ’åº
  blnx: inArg.blnx || false,       // åªä¿ç•™é«˜å€ç‡
  numone: inArg.one || false,      // æ¸…ç†å•èŠ‚ç‚¹åºå·
  clear: inArg.clear !== undefined ? inArg.clear : true,  // æ¸…ç†ä¹±å
  addflag: inArg.flag || false,    // æ·»åŠ å›½æ——
  nm: inArg.nm || false,           // ä¿ç•™æœªåŒ¹é…èŠ‚ç‚¹

  // v2.0 æ–°å¢åŠŸèƒ½å¼€å…³
  enableCategory: inArg.category || false,   // æ™ºèƒ½åˆ†ç±»
  enableStreaming: inArg.streaming || false, // æµåª’ä½“è¯†åˆ«
  enableGaming: inArg.gaming || false,       // æ¸¸æˆèŠ‚ç‚¹è¯†åˆ«
  enableAI: inArg.ai || false                // AIæœåŠ¡è¯†åˆ«
};

// åˆ†éš”ç¬¦é…ç½®
const SEPARATORS = {
  FGF: inArg.fgf === undefined ? " " : decodeURI(inArg.fgf),      // ä¸»åˆ†éš”ç¬¦
  XHFGF: inArg.sn === undefined ? " " : decodeURI(inArg.sn),      // åºå·åˆ†éš”ç¬¦
};

// è‡ªå®šä¹‰å†…å®¹é…ç½®
const CUSTOM = {
  FNAME: inArg.name === undefined ? "" : decodeURI(inArg.name),   // æœºåœºåå‰ç¼€
  BLKEY: inArg.blkey === undefined ? "" : decodeURI(inArg.blkey), // ä¿ç•™å…³é”®è¯
  blockquic: inArg.blockquic === undefined ? "" : decodeURI(inArg.blockquic)
};

// è¾“å…¥è¾“å‡ºæ ¼å¼æ˜ å°„
const nameMap = {
  cn: "cn", zh: "cn",
  us: "us", en: "us",
  quan: "quan",
  gq: "gq", flag: "gq"
};

const inname = nameMap[inArg.in] || "";
const outputName = nameMap[inArg.out] || "";

// ====================================================================================================
// å›½å®¶/åœ°åŒºæ•°æ®åº“ - ç»“æ„åŒ–æ•°æ® (215+ åœ°åŒº)
// ====================================================================================================

// å›½æ——æ•°ç»„ (æ–°å¢50+åœ°åŒº)
const FG = [
  // æ ¸å¿ƒåœ°åŒº (å‰11ä¸ª)
  'ğŸ‡­ğŸ‡°','ğŸ‡²ğŸ‡´','ğŸ‡¹ğŸ‡¼','ğŸ‡¯ğŸ‡µ','ğŸ‡°ğŸ‡·','ğŸ‡¸ğŸ‡¬','ğŸ‡ºğŸ‡¸','ğŸ‡¬ğŸ‡§','ğŸ‡«ğŸ‡·','ğŸ‡©ğŸ‡ª','ğŸ‡¦ğŸ‡º',
  // åŸæœ‰180ä¸ªåœ°åŒº
  'ğŸ‡¦ğŸ‡ª','ğŸ‡¦ğŸ‡«','ğŸ‡¦ğŸ‡±','ğŸ‡©ğŸ‡¿','ğŸ‡¦ğŸ‡´','ğŸ‡¦ğŸ‡·','ğŸ‡¦ğŸ‡²','ğŸ‡¦ğŸ‡¹','ğŸ‡¦ğŸ‡¿','ğŸ‡§ğŸ‡­','ğŸ‡§ğŸ‡©','ğŸ‡§ğŸ‡¾','ğŸ‡§ğŸ‡ª','ğŸ‡§ğŸ‡¿','ğŸ‡§ğŸ‡¯','ğŸ‡§ğŸ‡¹','ğŸ‡§ğŸ‡´','ğŸ‡§ğŸ‡¦','ğŸ‡§ğŸ‡¼','ğŸ‡§ğŸ‡·','ğŸ‡»ğŸ‡¬','ğŸ‡§ğŸ‡³','ğŸ‡§ğŸ‡¬','ğŸ‡§ğŸ‡«','ğŸ‡§ğŸ‡®',
  'ğŸ‡°ğŸ‡­','ğŸ‡¨ğŸ‡²','ğŸ‡¨ğŸ‡¦','ğŸ‡¨ğŸ‡»','ğŸ‡°ğŸ‡¾','ğŸ‡¨ğŸ‡«','ğŸ‡¹ğŸ‡©','ğŸ‡¨ğŸ‡±','ğŸ‡¨ğŸ‡´','ğŸ‡°ğŸ‡²','ğŸ‡¨ğŸ‡¬','ğŸ‡¨ğŸ‡©','ğŸ‡¨ğŸ‡·','ğŸ‡­ğŸ‡·','ğŸ‡¨ğŸ‡¾','ğŸ‡¨ğŸ‡¿','ğŸ‡©ğŸ‡°','ğŸ‡©ğŸ‡¯','ğŸ‡©ğŸ‡´','ğŸ‡ªğŸ‡¨','ğŸ‡ªğŸ‡¬','ğŸ‡¸ğŸ‡»','ğŸ‡¬ğŸ‡¶','ğŸ‡ªğŸ‡·','ğŸ‡ªğŸ‡ª',
  'ğŸ‡ªğŸ‡¹','ğŸ‡«ğŸ‡¯','ğŸ‡«ğŸ‡®','ğŸ‡¬ğŸ‡¦','ğŸ‡¬ğŸ‡²','ğŸ‡¬ğŸ‡ª','ğŸ‡¬ğŸ‡­','ğŸ‡¬ğŸ‡·','ğŸ‡¬ğŸ‡±','ğŸ‡¬ğŸ‡¹','ğŸ‡¬ğŸ‡³','ğŸ‡¬ğŸ‡¾','ğŸ‡­ğŸ‡¹','ğŸ‡­ğŸ‡³','ğŸ‡­ğŸ‡º','ğŸ‡®ğŸ‡¸','ğŸ‡®ğŸ‡³','ğŸ‡®ğŸ‡©','ğŸ‡®ğŸ‡·','ğŸ‡®ğŸ‡¶','ğŸ‡®ğŸ‡ª','ğŸ‡®ğŸ‡²','ğŸ‡®ğŸ‡±','ğŸ‡®ğŸ‡¹','ğŸ‡¨ğŸ‡®',
  'ğŸ‡¯ğŸ‡²','ğŸ‡¯ğŸ‡´','ğŸ‡°ğŸ‡¿','ğŸ‡°ğŸ‡ª','ğŸ‡°ğŸ‡¼','ğŸ‡°ğŸ‡¬','ğŸ‡±ğŸ‡¦','ğŸ‡±ğŸ‡»','ğŸ‡±ğŸ‡§','ğŸ‡±ğŸ‡¸','ğŸ‡±ğŸ‡·','ğŸ‡±ğŸ‡¾','ğŸ‡±ğŸ‡¹','ğŸ‡±ğŸ‡º','ğŸ‡²ğŸ‡°','ğŸ‡²ğŸ‡¬','ğŸ‡²ğŸ‡¼','ğŸ‡²ğŸ‡¾','ğŸ‡²ğŸ‡»','ğŸ‡²ğŸ‡±','ğŸ‡²ğŸ‡¹','ğŸ‡²ğŸ‡·','ğŸ‡²ğŸ‡º','ğŸ‡²ğŸ‡½',
  'ğŸ‡²ğŸ‡©','ğŸ‡²ğŸ‡¨','ğŸ‡²ğŸ‡³','ğŸ‡²ğŸ‡ª','ğŸ‡²ğŸ‡¦','ğŸ‡²ğŸ‡¿','ğŸ‡²ğŸ‡²','ğŸ‡³ğŸ‡¦','ğŸ‡³ğŸ‡µ','ğŸ‡³ğŸ‡±','ğŸ‡³ğŸ‡¿','ğŸ‡³ğŸ‡®','ğŸ‡³ğŸ‡ª','ğŸ‡³ğŸ‡¬','ğŸ‡°ğŸ‡µ','ğŸ‡³ğŸ‡´','ğŸ‡´ğŸ‡²','ğŸ‡µğŸ‡°','ğŸ‡µğŸ‡¦','ğŸ‡µğŸ‡¾','ğŸ‡µğŸ‡ª','ğŸ‡µğŸ‡­','ğŸ‡µğŸ‡¹','ğŸ‡µğŸ‡·','ğŸ‡¶ğŸ‡¦',
  'ğŸ‡·ğŸ‡´','ğŸ‡·ğŸ‡º','ğŸ‡·ğŸ‡¼','ğŸ‡¸ğŸ‡²','ğŸ‡¸ğŸ‡¦','ğŸ‡¸ğŸ‡³','ğŸ‡·ğŸ‡¸','ğŸ‡¸ğŸ‡±','ğŸ‡¸ğŸ‡°','ğŸ‡¸ğŸ‡®','ğŸ‡¸ğŸ‡´','ğŸ‡¿ğŸ‡¦','ğŸ‡ªğŸ‡¸','ğŸ‡±ğŸ‡°','ğŸ‡¸ğŸ‡©','ğŸ‡¸ğŸ‡·','ğŸ‡¸ğŸ‡¿','ğŸ‡¸ğŸ‡ª','ğŸ‡¨ğŸ‡­','ğŸ‡¸ğŸ‡¾','ğŸ‡¹ğŸ‡¯','ğŸ‡¹ğŸ‡¿','ğŸ‡¹ğŸ‡­','ğŸ‡¹ğŸ‡¬','ğŸ‡¹ğŸ‡´',
  'ğŸ‡¹ğŸ‡¹','ğŸ‡¹ğŸ‡³','ğŸ‡¹ğŸ‡·','ğŸ‡¹ğŸ‡²','ğŸ‡»ğŸ‡®','ğŸ‡ºğŸ‡¬','ğŸ‡ºğŸ‡¦','ğŸ‡ºğŸ‡¾','ğŸ‡ºğŸ‡¿','ğŸ‡»ğŸ‡ª','ğŸ‡»ğŸ‡³','ğŸ‡¾ğŸ‡ª','ğŸ‡¿ğŸ‡²','ğŸ‡¿ğŸ‡¼','ğŸ‡¦ğŸ‡©','ğŸ‡·ğŸ‡ª','ğŸ‡µğŸ‡±','ğŸ‡¬ğŸ‡º','ğŸ‡»ğŸ‡¦','ğŸ‡±ğŸ‡®','ğŸ‡¨ğŸ‡¼','ğŸ‡¸ğŸ‡¨','ğŸ‡¦ğŸ‡¶','ğŸ‡¬ğŸ‡®','ğŸ‡¨ğŸ‡º','ğŸ‡«ğŸ‡´','ğŸ‡¦ğŸ‡½','ğŸ‡§ğŸ‡²','ğŸ‡¹ğŸ‡±',
  // v2.0 æ–°å¢åœ°åŒº
  'ğŸ‡µğŸ‡¦','ğŸ‡¨ğŸ‡·','ğŸ‡§ğŸ‡¬','ğŸ‡·ğŸ‡´','ğŸ‡¨ğŸ‡¾','ğŸ‡°ğŸ‡ª','ğŸ‡³ğŸ‡¬','ğŸ‡¨ğŸ‡±','ğŸ‡¨ğŸ‡´','ğŸ‡¦ğŸ‡·'
];

// è‹±æ–‡ç¼©å†™æ•°ç»„
const EN = [
  'HK','MO','TW','JP','KR','SG','US','GB','FR','DE','AU',
  'AE','AF','AL','DZ','AO','AR','AM','AT','AZ','BH','BD','BY','BE','BZ','BJ','BT','BO','BA','BW','BR','VG','BN','BG','BF','BI',
  'KH','CM','CA','CV','KY','CF','TD','CL','CO','KM','CG','CD','CR','HR','CY','CZ','DK','DJ','DO','EC','EG','SV','GQ','ER','EE',
  'ET','FJ','FI','GA','GM','GE','GH','GR','GL','GT','GN','GY','HT','HN','HU','IS','IN','ID','IR','IQ','IE','IM','IL','IT','CI',
  'JM','JO','KZ','KE','KW','KG','LA','LV','LB','LS','LR','LY','LT','LU','MK','MG','MW','MY','MV','ML','MT','MR','MU','MX',
  'MD','MC','MN','ME','MA','MZ','MM','NA','NP','NL','NZ','NI','NE','NG','KP','NO','OM','PK','PA','PY','PE','PH','PT','PR','QA',
  'RO','RU','RW','SM','SA','SN','RS','SL','SK','SI','SO','ZA','ES','LK','SD','SR','SZ','SE','CH','SY','TJ','TZ','TH','TG','TO',
  'TT','TN','TR','TM','VI','UG','UA','UY','UZ','VE','VN','YE','ZM','ZW','AD','RE','PL','GU','VA','LI','CW','SC','AQ','GI','CU','FO','AX','BM','TL',
  // v2.0 æ–°å¢
  'PA','CR','BG','RO','CY','KE','NG','CL','CO','AR'
];

// ä¸­æ–‡åæ•°ç»„
const ZH = [
  'é¦™æ¸¯','æ¾³é—¨','å°æ¹¾','æ—¥æœ¬','éŸ©å›½','æ–°åŠ å¡','ç¾å›½','è‹±å›½','æ³•å›½','å¾·å›½','æ¾³å¤§åˆ©äºš',
  'é˜¿è”é…‹','é˜¿å¯Œæ±—','é˜¿å°”å·´å°¼äºš','é˜¿å°”åŠåˆ©äºš','å®‰å“¥æ‹‰','é˜¿æ ¹å»·','äºšç¾å°¼äºš','å¥¥åœ°åˆ©','é˜¿å¡æ‹œç–†','å·´æ—','å­ŸåŠ æ‹‰å›½','ç™½ä¿„ç½—æ–¯','æ¯”åˆ©æ—¶','ä¼¯åˆ©å…¹','è´å®','ä¸ä¸¹','ç»åˆ©ç»´äºš','æ³¢æ–¯å°¼äºšå’Œé»‘å¡å“¥ç»´é‚£','åšèŒ¨ç“¦çº³','å·´è¥¿','è‹±å±ç»´äº¬ç¾¤å²›','æ–‡è±','ä¿åŠ åˆ©äºš','å¸ƒåŸºçº³æ³•ç´¢','å¸ƒéš†è¿ª',
  'æŸ¬åŸ”å¯¨','å–€éº¦éš†','åŠ æ‹¿å¤§','ä½›å¾—è§’','å¼€æ›¼ç¾¤å²›','ä¸­éå…±å’Œå›½','ä¹å¾—','æ™ºåˆ©','å“¥ä¼¦æ¯”äºš','ç§‘æ‘©ç½—','åˆšæœ(å¸ƒ)','åˆšæœ(é‡‘)','å“¥æ–¯è¾¾é»åŠ ','å…‹ç½—åœ°äºš','å¡æµ¦è·¯æ–¯','æ·å…‹','ä¸¹éº¦','å‰å¸ƒæ','å¤šç±³å°¼åŠ å…±å’Œå›½','å„ç“œå¤šå°”','åŸƒåŠ','è¨å°”ç“¦å¤š','èµ¤é“å‡ å†…äºš','å„ç«‹ç‰¹é‡Œäºš','çˆ±æ²™å°¼äºš',
  'åŸƒå¡ä¿„æ¯”äºš','æ–æµ','èŠ¬å…°','åŠ è“¬','å†ˆæ¯”äºš','æ ¼é²å‰äºš','åŠ çº³','å¸Œè…Š','æ ¼é™µå…°','å±åœ°é©¬æ‹‰','å‡ å†…äºš','åœ­äºšé‚£','æµ·åœ°','æ´ªéƒ½æ‹‰æ–¯','åŒˆç‰™åˆ©','å†°å²›','å°åº¦','å°å°¼','ä¼Šæœ—','ä¼Šæ‹‰å…‹','çˆ±å°”å…°','é©¬æ©å²›','ä»¥è‰²åˆ—','æ„å¤§åˆ©','ç§‘ç‰¹è¿ªç“¦',
  'ç‰™ä¹°åŠ ','çº¦æ—¦','å“ˆè¨å…‹æ–¯å¦','è‚¯å°¼äºš','ç§‘å¨ç‰¹','å‰å°”å‰æ–¯æ–¯å¦','è€æŒ','æ‹‰è„±ç»´äºš','é»å·´å«©','è±ç´¢æ‰˜','åˆ©æ¯”é‡Œäºš','åˆ©æ¯”äºš','ç«‹é™¶å®›','å¢æ£®å ¡','é©¬å…¶é¡¿','é©¬è¾¾åŠ æ–¯åŠ ','é©¬æ‹‰ç»´','é©¬æ¥è¥¿äºš','é©¬å°”ä»£å¤«','é©¬é‡Œ','é©¬è€³ä»–','æ¯›åˆ©å¡”å°¼äºš','æ¯›é‡Œæ±‚æ–¯','å¢¨è¥¿å“¥',
  'æ‘©å°”å¤šç“¦','æ‘©çº³å“¥','è’™å¤','é»‘å±±å…±å’Œå›½','æ‘©æ´›å“¥','è«æ¡‘æ¯”å…‹','ç¼…ç”¸','çº³ç±³æ¯”äºš','å°¼æ³Šå°”','è·å…°','æ–°è¥¿å…°','å°¼åŠ æ‹‰ç“œ','å°¼æ—¥å°”','å°¼æ—¥åˆ©äºš','æœé²œ','æŒªå¨','é˜¿æ›¼','å·´åŸºæ–¯å¦','å·´æ‹¿é©¬','å·´æ‹‰åœ­','ç§˜é²','è²å¾‹å®¾','è‘¡è„ç‰™','æ³¢å¤šé»å„','å¡å¡”å°”',
  'ç½—é©¬å°¼äºš','ä¿„ç½—æ–¯','å¢æ—ºè¾¾','åœ£é©¬åŠ›è¯º','æ²™ç‰¹é˜¿æ‹‰ä¼¯','å¡å†…åŠ å°”','å¡å°”ç»´äºš','å¡æ‹‰åˆ©æ˜‚','æ–¯æ´›ä¼å…‹','æ–¯æ´›æ–‡å°¼äºš','ç´¢é©¬é‡Œ','å—é','è¥¿ç­ç‰™','æ–¯é‡Œå…°å¡','è‹ä¸¹','è‹é‡Œå—','æ–¯å¨å£«å…°','ç‘å…¸','ç‘å£«','å™åˆ©äºš','å¡”å‰å…‹æ–¯å¦','å¦æ¡‘å°¼äºš','æ³°å›½','å¤šå“¥','æ±¤åŠ ',
  'ç‰¹ç«‹å°¼è¾¾å’Œå¤šå·´å“¥','çªå°¼æ–¯','åœŸè€³å…¶','åœŸåº“æ›¼æ–¯å¦','ç¾å±ç»´å°”äº¬ç¾¤å²›','ä¹Œå¹²è¾¾','ä¹Œå…‹å…°','ä¹Œæ‹‰åœ­','ä¹Œå…¹åˆ«å…‹æ–¯å¦','å§”å†…ç‘æ‹‰','è¶Šå—','ä¹Ÿé—¨','èµæ¯”äºš','æ´¥å·´å¸ƒéŸ¦','å®‰é“å°”','ç•™å°¼æ±ª','æ³¢å…°','å…³å²›','æ¢µè’‚å†ˆ','åˆ—æ”¯æ•¦å£«ç™»','åº“æ‹‰ç´¢','å¡èˆŒå°”','å—æ','ç›´å¸ƒç½—é™€','å¤å·´','æ³•ç½—ç¾¤å²›','å¥¥å…°ç¾¤å²›','ç™¾æ…•è¾¾','ä¸œå¸æ±¶',
  // v2.0 æ–°å¢
  'å·´æ‹¿é©¬','å“¥æ–¯è¾¾é»åŠ ','ä¿åŠ åˆ©äºš','ç½—é©¬å°¼äºš','å¡æµ¦è·¯æ–¯','è‚¯å°¼äºš','å°¼æ—¥åˆ©äºš','æ™ºåˆ©','å“¥ä¼¦æ¯”äºš','é˜¿æ ¹å»·'
];

// è‹±æ–‡å…¨ç§°æ•°ç»„
const QC = [
  'Hong Kong','Macao','Taiwan','Japan','Korea','Singapore','United States','United Kingdom','France','Germany','Australia',
  'Dubai','Afghanistan','Albania','Algeria','Angola','Argentina','Armenia','Austria','Azerbaijan','Bahrain','Bangladesh','Belarus','Belgium','Belize','Benin','Bhutan','Bolivia','Bosnia and Herzegovina','Botswana','Brazil','British Virgin Islands','Brunei','Bulgaria','Burkina-faso','Burundi',
  'Cambodia','Cameroon','Canada','CapeVerde','CaymanIslands','Central African Republic','Chad','Chile','Colombia','Comoros','Congo-Brazzaville','Congo-Kinshasa','CostaRica','Croatia','Cyprus','Czech Republic','Denmark','Djibouti','Dominican Republic','Ecuador','Egypt','EISalvador','Equatorial Guinea','Eritrea','Estonia',
  'Ethiopia','Fiji','Finland','Gabon','Gambia','Georgia','Ghana','Greece','Greenland','Guatemala','Guinea','Guyana','Haiti','Honduras','Hungary','Iceland','India','Indonesia','Iran','Iraq','Ireland','Isle of Man','Israel','Italy','Ivory Coast',
  'Jamaica','Jordan','Kazakstan','Kenya','Kuwait','Kyrgyzstan','Laos','Latvia','Lebanon','Lesotho','Liberia','Libya','Lithuania','Luxembourg','Macedonia','Madagascar','Malawi','Malaysia','Maldives','Mali','Malta','Mauritania','Mauritius','Mexico',
  'Moldova','Monaco','Mongolia','Montenegro','Morocco','Mozambique','Myanmar(Burma)','Namibia','Nepal','Netherlands','New Zealand','Nicaragua','Niger','Nigeria','NorthKorea','Norway','Oman','Pakistan','Panama','Paraguay','Peru','Philippines','Portugal','PuertoRico','Qatar',
  'Romania','Russia','Rwanda','SanMarino','SaudiArabia','Senegal','Serbia','SierraLeone','Slovakia','Slovenia','Somalia','SouthAfrica','Spain','SriLanka','Sudan','Suriname','Swaziland','Sweden','Switzerland','Syria','Tajikstan','Tanzania','Thailand','Togo','Tonga',
  'TrinidadandTobago','Tunisia','Turkey','Turkmenistan','U.S.Virgin Islands','Uganda','Ukraine','Uruguay','Uzbekistan','Venezuela','Vietnam','Yemen','Zambia','Zimbabwe','Andorra','Reunion','Poland','Guam','Vatican','Liechtensteins','Curacao','Seychelles','Antarctica','Gibraltar','Cuba','Faroe Islands','Ahvenanmaa','Bermuda','Timor-Leste',
  // v2.0 æ–°å¢
  'Panama','Costa Rica','Bulgaria','Romania','Cyprus','Kenya','Nigeria','Chile','Colombia','Argentina'
];

// ====================================================================================================
// é¢„ç¼–è¯‘æ­£åˆ™è¡¨è¾¾å¼ - æ€§èƒ½ä¼˜åŒ–
// ====================================================================================================

const REGEX_CACHE = {
  // å€ç‡åŒ¹é…
  multiplier: /((å€ç‡|X|x|Ã—)\D?((\d{1,3}\.)?\d+)\D?)|((\d{1,3}\.)?\d+)(å€|X|x|Ã—)/,
  extractMultiplier: /(\d[\d.]*)/,

  // æ¸…ç†è§„åˆ™
  nameClear: /(å¥—é¤|åˆ°æœŸ|æœ‰æ•ˆ|å‰©ä½™|ç‰ˆæœ¬|å·²ç”¨|è¿‡æœŸ|å¤±è”|æµ‹è¯•|å®˜æ–¹|ç½‘å€|å¤‡ç”¨|ç¾¤|TEST|å®¢æœ|ç½‘ç«™|è·å–|è®¢é˜…|æµé‡|æœºåœº|ä¸‹æ¬¡|å®˜å€|è”ç³»|é‚®ç®±|å·¥å•|å­¦æœ¯|USE|USED|TOTAL|EXPIRE|EMAIL)/i,

  // å€ç‡ä¿ç•™
  nameblnx: /(é«˜å€|(?!1)2+(x|å€)|Ë£Â²|Ë£Â³|Ë£â´|Ë£âµ|Ë£Â¹â°)/i,
  namenx: /(é«˜å€|(?!1)(0\.|\d)+(x|å€)|Ë£Â²|Ë£Â³|Ë£â´|Ë£âµ|Ë£Â¹â°)/i,

  // å…³é”®åœ°åŒºåŒ¹é…
  keya: /æ¸¯|Hong|HK|æ–°åŠ å¡|SG|Singapore|æ—¥æœ¬|Japan|JP|ç¾å›½|United States|US|éŸ©|åœŸè€³å…¶|TR|Turkey|Korea|KR|ğŸ‡¸ğŸ‡¬|ğŸ‡­ğŸ‡°|ğŸ‡¯ğŸ‡µ|ğŸ‡ºğŸ‡¸|ğŸ‡°ğŸ‡·|ğŸ‡¹ğŸ‡·/i,
  keyb: /(((1|2|3|4)\d)|(é¦™æ¸¯|Hong|HK) 0[5-9]|((æ–°åŠ å¡|SG|Singapore|æ—¥æœ¬|Japan|JP|ç¾å›½|United States|US|éŸ©|åœŸè€³å…¶|TR|Turkey|Korea|KR) 0[3-9]))/i,

  // v2.0 æ–°å¢: æ™ºèƒ½åˆ†ç±»æ­£åˆ™
  gaming: /æ¸¸æˆ|Game|GAME|Steam|Epic|PlayStation|Xbox|Switch|ä½å»¶è¿Ÿ|Low.*?Latency/i,
  streaming: /Netflix|Disney|HBO|Hulu|AbemaTV|TVB|Viu|å·´å“ˆ|Bilibili|çˆ±å¥‡è‰º|è…¾è®¯è§†é¢‘|æµåª’ä½“|Streaming/i,
  aiService: /GPT|ChatGPT|OpenAI|Claude|Gemini|Bard|AI|äººå·¥æ™ºèƒ½/i,
  premiumLine: /IPLC|IEPL|CN2|GIA|ä¸“çº¿|Premium|é«˜çº§|æ²ªæ—¥|æ²ªç¾|æ·±æ¸¯|å¹¿æ¸¯|äº¬æ¸¯|äº¬æ—¥|äº¬ç¾/i,
  residential: /å®¶å®½|Residential|Fam|Home|ä½å®…/i,
  nativeIP: /åŸç”Ÿ|Native|è§£é”|Unlock|è½åœ°/i
};

// å›ºå®šæ ¼å¼æ ‡è¯†æ•°ç»„
const regexArray = [
  /Ë£Â²/, /Ë£Â³/, /Ë£â´/, /Ë£âµ/, /Ë£â¶/, /Ë£â·/, /Ë£â¸/, /Ë£â¹/, /Ë£Â¹â°/, /Ë£Â²â°/, /Ë£Â³â°/, /Ë£â´â°/, /Ë£âµâ°/,
  /IPLC/i, /IEPL/i, /CN2/i, /GIA/i,
  /æ ¸å¿ƒ/, /è¾¹ç¼˜/, /é«˜çº§/, /æ ‡å‡†/, /å®éªŒ/, /å•†å®½/, /å®¶å®½/,
  /æ¸¸æˆ|game/i, /è´­ç‰©/, /ä¸“çº¿/, /LB/, /cloudflare/i, /\budp\b/i, /\bgpt\b/i, /udpn\b/i,
  // v2.0 æ–°å¢è¯†åˆ«
  /Netflix/i, /Disney/i, /HBO/i, /åŸç”Ÿ/i, /è§£é”/i, /AI/i
];

const valueArray = [
  "2Ã—", "3Ã—", "4Ã—", "5Ã—", "6Ã—", "7Ã—", "8Ã—", "9Ã—", "10Ã—", "20Ã—", "30Ã—", "40Ã—", "50Ã—",
  "IPLC", "IEPL", "CN2", "GIA",
  "Kern", "Edge", "Pro", "Std", "Exp", "Biz", "Fam",
  "Game", "Buy", "Zx", "LB", "CF", "UDP", "GPT", "UDPN",
  // v2.0 æ–°å¢
  "Netflix", "Disney+", "HBO", "Native", "Unlock", "AI"
];

// ====================================================================================================
// åœ°åŒºåç§°é¢„å¤„ç†è§„åˆ™ - æ™ºèƒ½è¯†åˆ«å„ç§å˜ä½“
// ====================================================================================================

const rurekey = {
  // è‹±æ–‡è§„èŒƒåŒ–
  GB: /UK/g,
  "B-G-P": /BGP/g,

  // åŸå¸‚æ˜ å°„
  "Russia Moscow": /Moscow/g,
  "Korea Chuncheon": /Chuncheon|Seoul/g,
  "United Kingdom London": /London|Great Britain/g,
  "Dubai United Arab Emirates": /United Arab Emirates/g,
  "United States": /USA|Los Angeles|San Jose|Silicon Valley|Michigan|Seattle|Chicago|New York/g,

  // ç‰¹æ®Šå¤„ç†: å°æ¹¾(é˜²æ­¢è¢«è¯†åˆ«ä¸ºä¸­å›½)
  "Taiwan TW å°æ¹¾ ğŸ‡¹ğŸ‡¼": /(å°|Tai\s?wan|TW).*?ğŸ‡¨ğŸ‡³|ğŸ‡¨ğŸ‡³.*?(å°|Tai\s?wan|TW)/g,

  // ä¸­æ–‡åœ°åŒºè¯†åˆ«
  "Hong Kong": /Hongkong|HONG KONG/gi,
  æ¾³å¤§åˆ©äºš: /(æ·±|æ²ª|å‘¼|äº¬|å¹¿|æ­)æ¾³|æ¾³æ´²|å¢¨å°”æœ¬|æ‚‰å°¼|åœŸæ¾³|æ¾³å¤§åˆ©äº|Azure/g,
  å¾·å›½: /(æ·±|æ²ª|å‘¼|äº¬|å¹¿|æ­)å¾·(?!.*(I|çº¿))|æ³•å…°å…‹ç¦|æ»¬å¾·|å¾·åœ‹/g,
  é¦™æ¸¯: /(æ·±|æ²ª|å‘¼|äº¬|å¹¿|æ­)æ¸¯(?!.*(I|çº¿))/g,
  æ—¥æœ¬: /(æ·±|æ²ª|å‘¼|äº¬|å¹¿|æ­|ä¸­|è¾½)æ—¥(?!.*(I|çº¿))|ä¸œäº¬|å¤§å‚/g,
  æ–°åŠ å¡: /ç‹®åŸ|(æ·±|æ²ª|å‘¼|äº¬|å¹¿|æ­)æ–°/g,
  ç¾å›½: /(æ·±|æ²ª|å‘¼|äº¬|å¹¿|æ­)ç¾|æ³¢ç‰¹å…°|èŠåŠ å“¥|å“¥ä¼¦å¸ƒ|çº½çº¦|ç¡…è°·|ä¿„å‹’å†ˆ|è¥¿é›…å›¾|Rackdog/g,

  // å…¶ä»–åœ°åŒº
  æ³¢æ–¯å°¼äºšå’Œé»‘å¡å“¥ç»´é‚£: /æ³¢é»‘å…±å’Œå›½/g,
  å°å°¼: /å°åº¦å°¼è¥¿äºš|é›…åŠ è¾¾/g,
  å°åº¦: /å­Ÿä¹°/g,
  é˜¿è”é…‹: /è¿ªæ‹œ|é˜¿æ‹‰ä¼¯è”åˆé…‹é•¿å›½|é˜¿è¯é…‹/g,
  å­ŸåŠ æ‹‰å›½: /å­ŸåŠ æ‹‰/g,
  æ·å…‹: /æ·å…‹å…±å’Œå›½/g,
  ä¸­å›½: /å†…è’™|æ±Ÿè‹|æ·±åœ³|åŒ—äº¬|å››å·/g,
  å°æ¹¾: /æ–°å°|æ–°åŒ—|å°(?!.*çº¿)/g,
  Taiwan: /Taipei/g,
  æ¾³é—¨: /æ¾³é–€/g,
  éŸ©å›½: /æ˜¥å·|éŸ©|é¦–å°”/g,
  Japan: /Tokyo|Osaka/g,
  è‹±å›½: /ä¼¦æ•¦/g,
  India: /Mumbai/g,
  Germany: /Frankfurt/g,
  Switzerland: /Zurich/g,
  ä¿„ç½—æ–¯: /è«æ–¯ç§‘/g,
  åœŸè€³å…¶: /ä¼Šæ–¯å¦å¸ƒå°”/g,
  æ³°å›½: /æ³°åœ‹|æ›¼è°·/g,
  æ³•å›½: /å·´é»|æ³•åœ‹/g,
  è²å¾‹å®¾: /è²å¾‹è³“/g,
  å†°å²›: /å†°å³¶/g,
  æ„å¤§åˆ©: /ç¾©å¤§åˆ©/g,
  ä¹Œå…‹å…°: /çƒå…‹è˜­/g,
  é©¬æ¥è¥¿äºš: /é¦¬ä¾†è¥¿äº/g,
  è·å…°: /è·è˜­|é˜¿å§†æ–¯ç‰¹ä¸¹/g,

  // v2.0 æ–°å¢åœ°åŒºè§„åˆ™
  å·´æ‹¿é©¬: /Panama|å·´æ‹¿é©¬/gi,
  å“¥æ–¯è¾¾é»åŠ : /Costa.*?Rica|å“¥æ–¯è¾¾é»åŠ /gi,
  ä¿åŠ åˆ©äºš: /Bulgaria|ä¿åŠ åˆ©äºš|ç´¢è²äºš/gi,
  ç½—é©¬å°¼äºš: /Romania|ç½—é©¬å°¼äºš|å¸ƒåŠ å‹’æ–¯ç‰¹/gi,
  è‚¯å°¼äºš: /Kenya|è‚¯å°¼äºš|å†…ç½—æ¯•/gi,
  å°¼æ—¥åˆ©äºš: /Nigeria|å°¼æ—¥åˆ©äºš|æ‹‰å„æ–¯/gi,
  æ™ºåˆ©: /Chile|æ™ºåˆ©|åœ£åœ°äºšå“¥/gi,
  å“¥ä¼¦æ¯”äºš: /Colombia|å“¥ä¼¦æ¯”äºš|æ³¢å“¥å¤§/gi,
  é˜¿æ ¹å»·: /Argentina|é˜¿æ ¹å»·|å¸ƒå®œè¯ºæ–¯è‰¾åˆ©æ–¯/gi,

  // å…¶ä»–
  G: /\d\s?GB/gi,
  Esnc: /esnc/gi
};

// ====================================================================================================
// v2.0 æ–°å¢: æ™ºèƒ½åˆ†ç±»ç³»ç»Ÿ
// ====================================================================================================

/**
 * èŠ‚ç‚¹åˆ†ç±»å™¨ - è¯†åˆ«èŠ‚ç‚¹ç‰¹æ®Šç”¨é€”
 * @param {string} nodeName èŠ‚ç‚¹åç§°
 * @returns {object} åˆ†ç±»ç»“æœ { type, prefix, keywords }
 */
function classifyNode(nodeName) {
  const classifications = [];

  // æ¸¸æˆä¼˜åŒ–èŠ‚ç‚¹
  if (CONFIG.enableGaming && REGEX_CACHE.gaming.test(nodeName)) {
    classifications.push({ type: 'gaming', prefix: 'ğŸ®', keyword: 'Game' });
  }

  // æµåª’ä½“èŠ‚ç‚¹
  if (CONFIG.enableStreaming && REGEX_CACHE.streaming.test(nodeName)) {
    // è¯¦ç»†è¯†åˆ«å…·ä½“å¹³å°
    if (/Netflix/i.test(nodeName)) classifications.push({ type: 'streaming', prefix: 'ğŸ¬', keyword: 'Netflix' });
    else if (/Disney/i.test(nodeName)) classifications.push({ type: 'streaming', prefix: 'ğŸ°', keyword: 'Disney+' });
    else if (/HBO/i.test(nodeName)) classifications.push({ type: 'streaming', prefix: 'ğŸ“½ï¸', keyword: 'HBO' });
    else if (/å·´å“ˆ/i.test(nodeName)) classifications.push({ type: 'streaming', prefix: 'ğŸŒ', keyword: 'å·´å“ˆ' });
    else classifications.push({ type: 'streaming', prefix: 'ğŸ“º', keyword: 'Stream' });
  }

  // AIæœåŠ¡èŠ‚ç‚¹
  if (CONFIG.enableAI && REGEX_CACHE.aiService.test(nodeName)) {
    classifications.push({ type: 'ai', prefix: 'ğŸ¤–', keyword: 'AI' });
  }

  // IPLCä¸“çº¿
  if (REGEX_CACHE.premiumLine.test(nodeName)) {
    classifications.push({ type: 'premium', prefix: 'âš¡', keyword: 'Premium' });
  }

  // å®¶å®½IP
  if (REGEX_CACHE.residential.test(nodeName)) {
    classifications.push({ type: 'residential', prefix: 'ğŸ ', keyword: 'Fam' });
  }

  // åŸç”ŸIP
  if (REGEX_CACHE.nativeIP.test(nodeName)) {
    classifications.push({ type: 'native', prefix: 'ğŸ”“', keyword: 'Native' });
  }

  return classifications;
}

// ====================================================================================================
// æ ¸å¿ƒå¤„ç†å‡½æ•°
// ====================================================================================================

let GetK = false;
let AMK = [];

/**
 * æ„å»ºå›½å®¶æ˜ å°„è¡¨ - ä½¿ç”¨Mapä¼˜åŒ–æŸ¥æ‰¾æ€§èƒ½
 * @param {object} allMap å›½å®¶æ˜ å°„å¯¹è±¡
 */
function ObjKA(allMap) {
  GetK = true;
  AMK = Object.entries(allMap);
}

/**
 * è·å–æŒ‡å®šæ ¼å¼çš„å›½å®¶åˆ—è¡¨
 * @param {string} arg æ ¼å¼å‚æ•°: us/gq/quan/cn
 * @returns {Array} å›½å®¶åˆ—è¡¨æ•°ç»„
 */
function getList(arg) {
  switch (arg) {
    case 'us': return EN;
    case 'gq': return FG;
    case 'quan': return QC;
    default: return ZH;
  }
}

/**
 * ä¸»å¤„ç†å‡½æ•° - èŠ‚ç‚¹é‡å‘½åæ ¸å¿ƒé€»è¾‘
 * @param {Array} proxies èŠ‚ç‚¹æ•°ç»„
 * @returns {Array} å¤„ç†åçš„èŠ‚ç‚¹æ•°ç»„
 */
function operator(proxies) {
  try {
    const Allmap = {};
    const outList = getList(outputName);
    let inputList;
    let retainKey = "";

    // ç¡®å®šè¾“å…¥æ ¼å¼åˆ—è¡¨
    if (inname !== "") {
      inputList = [getList(inname)];
    } else {
      inputList = [ZH, FG, QC, EN];
    }

    // æ„å»ºå›½å®¶æ˜ å°„è¡¨
    inputList.forEach((arr) => {
      arr.forEach((value, valueIndex) => {
        Allmap[value] = outList[valueIndex];
      });
    });

    // ===== ç¬¬ä¸€æ­¥: è¿‡æ»¤ä¸éœ€è¦çš„èŠ‚ç‚¹ =====
    if (CONFIG.clear || CONFIG.nx || CONFIG.blnx || CONFIG.key) {
      proxies = proxies.filter((res) => {
        const resname = res.name;
        const shouldKeep =
          !(CONFIG.clear && REGEX_CACHE.nameClear.test(resname)) &&
          !(CONFIG.nx && REGEX_CACHE.namenx.test(resname)) &&
          !(CONFIG.blnx && !REGEX_CACHE.nameblnx.test(resname)) &&
          !(CONFIG.key && !(REGEX_CACHE.keya.test(resname) && /2|4|6|7/i.test(resname)));
        return shouldKeep;
      });
    }

    const BLKEYS = CUSTOM.BLKEY ? CUSTOM.BLKEY.split("+") : "";

    // ===== ç¬¬äºŒæ­¥: å¤„ç†æ¯ä¸ªèŠ‚ç‚¹ =====
    proxies.forEach((e) => {
      let bktf = false;
      const ens = e.name;

      // é¢„å¤„ç†: åœ°åŒºåç§°è§„èŒƒåŒ–
      Object.keys(rurekey).forEach((ikey) => {
        if (rurekey[ikey].test(e.name)) {
          e.name = e.name.replace(rurekey[ikey], ikey);

          // å¤„ç†è‡ªå®šä¹‰ä¿ç•™å…³é”®è¯
          if (CUSTOM.BLKEY) {
            bktf = true;
            let BLKEY_REPLACE = "";
            let re = false;

            BLKEYS.forEach((i) => {
              if (i.includes(">") && ens.includes(i.split(">")[0])) {
                if (rurekey[ikey].test(i.split(">")[0])) {
                  e.name += " " + i.split(">")[0];
                }
                if (i.split(">")[1]) {
                  BLKEY_REPLACE = i.split(">")[1];
                  re = true;
                }
              } else {
                if (ens.includes(i)) {
                  e.name += " " + i;
                }
              }
              retainKey = re ? BLKEY_REPLACE : BLKEYS.filter((items) => e.name.includes(items));
            });
          }
        }
      });

      // å¤„ç† block-quic è®¾ç½®
      if (CUSTOM.blockquic === "on") {
        e["block-quic"] = true;
      } else if (CUSTOM.blockquic === "off") {
        e["block-quic"] = false;
      } else {
        delete e["block-quic"];
      }

      // å¤„ç†æœªåŒ¹é…çš„è‡ªå®šä¹‰å…³é”®è¯
      if (!bktf && CUSTOM.BLKEY) {
        let BLKEY_REPLACE = "";
        let re = false;

        BLKEYS.forEach((i) => {
          if (i.includes(">") && e.name.includes(i.split(">")[0])) {
            if (i.split(">")[1]) {
              BLKEY_REPLACE = i.split(">")[1];
              re = true;
            }
          }
        });
        retainKey = re ? BLKEY_REPLACE : BLKEYS.filter((items) => e.name.includes(items));
      }

      let ikey = "";
      let ikeys = "";

      // ä¿ç•™å›ºå®šæ ¼å¼æ ‡è¯†
      if (CONFIG.blgd) {
        regexArray.forEach((regex, index) => {
          if (regex.test(e.name)) {
            ikeys = valueArray[index];
          }
        });
      }

      // æ­£åˆ™åŒ¹é…å€ç‡
      if (CONFIG.bl) {
        const match = e.name.match(REGEX_CACHE.multiplier);
        if (match) {
          const rev = match[0].match(REGEX_CACHE.extractMultiplier)[0];
          if (rev !== "1") {
            ikey = rev + "Ã—";
          }
        }
      }

      // v2.0: æ™ºèƒ½åˆ†ç±»
      let categoryTags = [];
      if (CONFIG.enableCategory) {
        const classifications = classifyNode(e.name);
        categoryTags = classifications.map(c => c.keyword);
      }

      // æ„å»ºå›½å®¶æ˜ å°„è¡¨(æ‡’åŠ è½½)
      !GetK && ObjKA(Allmap);

      // åŒ¹é…å›½å®¶/åœ°åŒº
      const findKey = AMK.find(([key]) => e.name.includes(key));

      let firstName = "";
      let nNames = "";

      // å¤„ç†æœºåœºåå‰ç¼€ä½ç½®
      if (CONFIG.nf) {
        firstName = CUSTOM.FNAME;
      } else {
        nNames = CUSTOM.FNAME;
      }

      if (findKey?.[1]) {
        const findKeyValue = findKey[1];
        let keyover = [];
        let usflag = "";

        // æ·»åŠ å›½æ——
        if (CONFIG.addflag) {
          const index = outList.indexOf(findKeyValue);
          if (index !== -1) {
            usflag = FG[index];
            // ç‰¹æ®Šå¤„ç†: å°æ¹¾æ˜¾ç¤ºä¸­å›½å›½æ——çš„æƒ…å†µ
            usflag = usflag === "ğŸ‡¹ğŸ‡¼" ? "ğŸ‡¨ğŸ‡³" : usflag;
          }
        }

        // ç»„è£…æœ€ç»ˆèŠ‚ç‚¹å
        keyover = keyover
          .concat(firstName, usflag, nNames, findKeyValue, retainKey, ikey, ikeys, categoryTags)
          .filter((k) => k !== "");

        e.name = keyover.join(SEPARATORS.FGF);
      } else {
        // æœªåŒ¹é…åˆ°å›½å®¶çš„èŠ‚ç‚¹å¤„ç†
        if (CONFIG.nm) {
          e.name = CUSTOM.FNAME + SEPARATORS.FGF + e.name;
        } else {
          e.name = null;
        }
      }
    });

    // ç§»é™¤nullèŠ‚ç‚¹
    proxies = proxies.filter((e) => e.name !== null);

    // ===== ç¬¬ä¸‰æ­¥: æ·»åŠ åºå· =====
    addSequenceNumbers(proxies);

    // ===== ç¬¬å››æ­¥: æ¸…ç†å•èŠ‚ç‚¹åºå· =====
    CONFIG.numone && removeSingleNodeSequence(proxies);

    // ===== ç¬¬äº”æ­¥: ç‰¹æ®Šæ’åº =====
    CONFIG.blpx && (proxies = sortBySpecialFlags(proxies));

    // ===== ç¬¬å…­æ­¥: äºŒæ¬¡è¿‡æ»¤(å…³é”®è¯æ¨¡å¼) =====
    CONFIG.key && (proxies = proxies.filter((e) => !REGEX_CACHE.keyb.test(e.name)));

    return proxies;

  } catch (error) {
    // é”™è¯¯å¤„ç†
    console.error("[Rename Script Error]", error);
    return proxies;
  }
}

/**
 * æ·»åŠ åºå· - ä¸ºé‡å¤èŠ‚ç‚¹åæ·»åŠ åºå·
 * @param {Array} proxies èŠ‚ç‚¹æ•°ç»„
 * @returns {Array} æ·»åŠ åºå·åçš„èŠ‚ç‚¹æ•°ç»„
 */
function addSequenceNumbers(proxies) {
  // æ­¥éª¤1: æŒ‰èŠ‚ç‚¹ååˆ†ç»„å¹¶è®¡æ•°
  const grouped = proxies.reduce((accumulator, proxy) => {
    const existingGroup = accumulator.find(item => item.name === proxy.name);

    if (existingGroup) {
      // å·²å­˜åœ¨è¯¥èŠ‚ç‚¹åï¼Œå¢åŠ è®¡æ•°
      existingGroup.count++;
      existingGroup.items.push({
        ...proxy,
        name: `${proxy.name}${SEPARATORS.XHFGF}${existingGroup.count.toString().padStart(2, "0")}`
      });
    } else {
      // æ–°èŠ‚ç‚¹åï¼Œåˆ›å»ºæ–°åˆ†ç»„
      accumulator.push({
        name: proxy.name,
        count: 1,
        items: [{
          ...proxy,
          name: `${proxy.name}${SEPARATORS.XHFGF}01`
        }]
      });
    }
    return accumulator;
  }, []);

  // æ­¥éª¤2: å±•å¹³åˆ†ç»„ï¼Œå…¼å®¹æ—§ç‰ˆJavaScript
  const flattened = typeof Array.prototype.flatMap === 'function'
    ? grouped.flatMap(group => group.items)
    : grouped.reduce((acc, group) => acc.concat(group.items), []);

  // æ­¥éª¤3: æ›¿æ¢åŸæ•°ç»„å†…å®¹
  proxies.splice(0, proxies.length, ...flattened);
  return proxies;
}

/**
 * æ¸…ç†å•èŠ‚ç‚¹åºå· - ç§»é™¤åªæœ‰ä¸€ä¸ªèŠ‚ç‚¹çš„åœ°åŒºçš„ "01" åç¼€
 * @param {Array} proxies èŠ‚ç‚¹æ•°ç»„
 * @returns {Array} å¤„ç†åçš„èŠ‚ç‚¹æ•°ç»„
 */
function removeSingleNodeSequence(proxies) {
  // æŒ‰åŸºç¡€åç§°(ä¸å«åºå·)åˆ†ç»„
  const groups = proxies.reduce((acc, proxy) => {
    // ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼ç§»é™¤æœ«å°¾çš„åˆ†éš”ç¬¦å’Œæ•°å­—åºå·
    const escapedSeparator = SEPARATORS.XHFGF.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&');
    const baseName = proxy.name.replace(new RegExp(escapedSeparator + "\\d+$"), "");

    if (!acc[baseName]) {
      acc[baseName] = [];
    }
    acc[baseName].push(proxy);
    return acc;
  }, {});

  // éå†åˆ†ç»„ï¼Œå¦‚æœæŸç»„åªæœ‰ä¸€ä¸ªèŠ‚ç‚¹ï¼Œåˆ™ç§»é™¤å…¶åºå·åç¼€
  for (const baseName in groups) {
    if (groups[baseName].length === 1) {
      const proxyToModify = groups[baseName][0];
      proxyToModify.name = baseName;
    }
  }

  return proxies;
}

/**
 * ç‰¹æ®Šæ ‡è¯†æ’åº - å°†ç‰¹æ®ŠèŠ‚ç‚¹(IPLC/å€ç‡ç­‰)æ’åºåˆ°åé¢
 * @param {Array} proxies èŠ‚ç‚¹æ•°ç»„
 * @returns {Array} æ’åºåçš„èŠ‚ç‚¹æ•°ç»„
 */
function sortBySpecialFlags(proxies) {
  const specialRegex = [
    /(\d\.)?\d+Ã—/,
    /IPLC|IEPL|CN2|GIA|Kern|Edge|Pro|Std|Exp|Biz|Fam|Game|Buy|Zx|LB|Netflix|Disney|HBO|AI/i
  ];

  const withSpecial = [];
  const withoutSpecial = [];

  // åˆ†ç±»
  for (const proxy of proxies) {
    const hasSpecial = specialRegex.some((regex) => regex.test(proxy.name));
    if (hasSpecial) {
      withSpecial.push(proxy);
    } else {
      withoutSpecial.push(proxy);
    }
  }

  // ç‰¹æ®ŠèŠ‚ç‚¹æŒ‰æ ‡è¯†ç±»å‹æ’åº
  const specialIndices = withSpecial.map((proxy) =>
    specialRegex.findIndex((regex) => regex.test(proxy.name))
  );

  withSpecial.sort((a, b) => {
    const indexA = specialIndices[withSpecial.indexOf(a)];
    const indexB = specialIndices[withSpecial.indexOf(b)];
    return indexA - indexB || a.name.localeCompare(b.name);
  });

  // æ™®é€šèŠ‚ç‚¹ä¿æŒåŸé¡ºåº
  withoutSpecial.sort((a, b) => proxies.indexOf(a) - proxies.indexOf(b));

  // æ™®é€šèŠ‚ç‚¹åœ¨å‰ï¼Œç‰¹æ®ŠèŠ‚ç‚¹åœ¨å
  return withoutSpecial.concat(withSpecial);
}

// ====================================================================================================
// è„šæœ¬å…¥å£
// ====================================================================================================

// å¯¼å‡ºä¸»å¤„ç†å‡½æ•°
// Sub-Store ä¼šè°ƒç”¨ operator() å‡½æ•°å¤„ç†èŠ‚ç‚¹åˆ—è¡¨
